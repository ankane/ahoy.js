!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e=e||self).ahoy=t()}(this,function(){"use strict";function e(e){return void 0===e}function a(e){return Array.isArray(e)}function t(e){return e&&"number"==typeof e.size&&"string"==typeof e.type&&"function"==typeof e.slice}var s=function(n,i,o,r){return(i=i||{}).indices=!e(i.indices)&&i.indices,i.nullsAsUndefineds=!e(i.nullsAsUndefineds)&&i.nullsAsUndefineds,i.booleansAsIntegers=!e(i.booleansAsIntegers)&&i.booleansAsIntegers,o=o||new FormData,e(n)||(null===n?i.nullsAsUndefineds||o.append(r,""):"boolean"!=typeof n?a(n)?n.length&&n.forEach(function(e,t){s(e,i,o,r+"["+(i.indices?t:"")+"]")}):n instanceof Date?o.append(r,n.toISOString()):n!==Object(n)||t(n)&&"string"==typeof n.name&&("object"==typeof n.lastModifiedDate||"number"==typeof n.lastModified)||t(n)?o.append(r,n):Object.keys(n).forEach(function(e){var t=n[e];if(a(t))for(;2<e.length&&e.lastIndexOf("[]")===e.length-2;)e=e.substring(0,e.length-2);s(t,i,o,r?r+"["+e+"]":e)}):o.append(r,i.booleansAsIntegers?n?1:0:n)),o},i={set:function(e,t,n,i){var o,r="",a="";n&&((o=new Date).setTime(o.getTime()+60*n*1e3),r="; expires="+o.toGMTString()),i&&(a="; domain="+i),document.cookie=e+"="+escape(t)+r+a+"; path=/"},get:function(e){for(var t,n=e+"=",i=document.cookie.split(";"),o=0;o<i.length;o++){for(t=i[o];" "===t.charAt(0);)t=t.substring(1,t.length);if(0===t.indexOf(n))return unescape(t.substring(n.length,t.length))}return null}},r={urlPrefix:"",visitsUrl:"/ahoy/visits",eventsUrl:"/ahoy/events",page:null,platform:"Web",useBeacon:!0,startOnReady:!0,trackVisits:!0,cookies:!0,cookieDomain:null,headers:{},visitParams:{},withCredentials:!1,visitTtl:240},o=window.ahoy||window.Ahoy||{};o.configure=function(e){for(var t in e)e.hasOwnProperty(t)&&(r[t]=e[t])},o.configure(o);var n,c,u,f=window.jQuery||window.Zepto||window.$,d=!1,l=[],h="undefined"!=typeof JSON&&void 0!==JSON.stringify,v=[];function g(){return r.urlPrefix+r.eventsUrl}function p(){return(r.useBeacon||r.trackNow)&&(e=r.headers,0===Object.keys(e).length)&&h&&void 0!==window.navigator.sendBeacon&&!r.withCredentials;var e}function y(e,t,n){i.set(e,t,n,r.cookieDomain||r.domain)}function m(e){return i.get(e)}function k(e){i.set(e,"",-1)}function w(e){m("ahoy_debug")&&window.console.log(e)}function x(){for(var e;e=l.shift();)e();d=!0}function b(e){d?e():l.push(e)}function _(e,o,r){document.addEventListener(e,function(e){var t,n,i;t=e.target,n=o,((i=t.matches||t.matchesSelector||t.mozMatchesSelector||t.msMatchesSelector||t.oMatchesSelector||t.webkitMatchesSelector)?i.apply(t,[n]):void w("Unable to match"))&&r(e)})}function S(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)})}function O(){r.cookies&&h&&y("ahoy_events",JSON.stringify(v),1)}function T(){var e=document.querySelector("meta[name=csrf-token]");return e&&e.content}function A(e){var t=T();t&&e.setRequestHeader("X-CSRF-Token",t)}function C(e,t,n){if(h)if(f&&f.ajax)f.ajax({type:"POST",url:e,data:JSON.stringify(t),contentType:"application/json; charset=utf-8",dataType:"json",beforeSend:A,success:n,headers:r.headers,xhrFields:{withCredentials:r.withCredentials}});else{var i=new XMLHttpRequest;for(var o in i.open("POST",e,!0),i.withCredentials=r.withCredentials,i.setRequestHeader("Content-Type","application/json"),r.headers)r.headers.hasOwnProperty(o)&&i.setRequestHeader(o,r.headers[o]);i.onload=function(){200===i.status&&n()},A(i),i.send(JSON.stringify(t))}}function V(e){var t={events:[e]};return r.cookies&&(t.visit_token=e.visit_token,t.visitor_token=e.visitor_token),delete e.visit_token,delete e.visitor_token,t}function j(t){b(function(){C(g(),V(t),function(){for(var e=0;e<v.length;e++)if(v[e].id==t.id){v.splice(e,1);break}O()})})}function P(o){b(function(){var e,t=V(o),n=(e=document.querySelector("meta[name=csrf-param]"))&&e.content,i=T();n&&i&&(t[n]=i),t.events_json=JSON.stringify(t.events),delete t.events,window.navigator.sendBeacon(g(),s(t))})}function I(){return r.page||window.location.pathname}function M(e){return e&&0<e.length?e:null}function N(e){var t=e.target;return function(e){for(var t in e)e.hasOwnProperty(t)&&null===e[t]&&delete e[t];return e}({tag:t.tagName.toLowerCase(),id:M(t.id),class:M(t.className),page:I(),section:function(e){for(;e&&e!==document;e=e.parentNode)if(e.hasAttribute("data-section"))return e.getAttribute("data-section");return null}(t)})}function U(){if(d=!1,n=o.getVisitId(),c=o.getVisitorId(),u=m("ahoy_track"),!1===r.cookies||!1===r.trackVisits)w("Visit tracking disabled"),x();else if(n&&c&&!u)w("Active visit"),x();else if(n||y("ahoy_visit",n=S(),r.visitTtl),m("ahoy_visit")){w("Visit started"),c||y("ahoy_visitor",c=S(),1051200);var e={visit_token:n,visitor_token:c,platform:r.platform,landing_page:window.location.href,screen_width:window.screen.width,screen_height:window.screen.height,js:!0};for(var t in 0<document.referrer.length&&(e.referrer=document.referrer),r.visitParams)r.visitParams.hasOwnProperty(t)&&(e[t]=r.visitParams[t]);w(e),C(r.urlPrefix+r.visitsUrl,e,function(){k("ahoy_track"),x()})}else w("Cookies disabled"),x()}o.getVisitId=o.getVisitToken=function(){return m("ahoy_visit")},o.getVisitorId=o.getVisitorToken=function(){return m("ahoy_visitor")},o.reset=function(){return k("ahoy_visit"),k("ahoy_visitor"),k("ahoy_events"),k("ahoy_track"),!0},o.debug=function(e){return!1===e?k("ahoy_debug"):y("ahoy_debug","t",525600),!0},o.track=function(e,t){var n={name:e,properties:t||{},time:(new Date).getTime()/1e3,id:S(),js:!0};return b(function(){r.cookies&&!o.getVisitId()&&U(),b(function(){w(n),n.visit_token=o.getVisitId(),n.visitor_token=o.getVisitorId(),p()?P(n):(v.push(n),O(),setTimeout(function(){j(n)},1e3))})}),!0},o.trackView=function(e){var t={url:window.location.href,title:document.title,page:I()};if(e)for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);o.track("$view",t)},o.trackClicks=function(){_("click","a, button, input[type=submit]",function(e){var t=e.target,n=N(e);n.text="input"==n.tag?t.value:(t.textContent||t.innerText||t.innerHTML).replace(/[\s\r\n]+/g," ").trim(),n.href=t.href,o.track("$click",n)})},o.trackSubmits=function(){_("submit","form",function(e){var t=N(e);o.track("$submit",t)})},o.trackChanges=function(){_("change","input, textarea, select",function(e){var t=N(e);o.track("$change",t)})},o.trackAll=function(){o.trackView(),o.trackClicks(),o.trackSubmits(),o.trackChanges()};try{v=JSON.parse(m("ahoy_events")||"[]")}catch(a){}for(var D,J=0;J<v.length;J++)j(v[J]);return o.start=function(){U(),o.start=function(){}},D=function(){r.startOnReady&&o.start()},"interactive"===document.readyState||"complete"===document.readyState?setTimeout(D,0):document.addEventListener("DOMContentLoaded",D),o});
